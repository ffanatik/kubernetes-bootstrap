---
- name: Disable SWAP as Kubernetes requirement
  ansible.builtin.shell: |
    swapoff -a
  when: ansible_swaptotal_mb > 0

- name: Disable SWAP as Kubernetes requirement
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+.*)$'
    replace: '# \1'

- name: Permanent disable swap
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "1"
    state: present

- name: Load required modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  with_items:
    - br_netfilter
    - overlay
    - ip_vs
    - ip_vs_rr
    - ip_vs_wrr
    - ip_vs_sh
    - nf_conntrack

- name: Load kernel modules at bootup
  ansible.builtin.blockinfile:
    path: /etc/modules-load.d/kubernetes.conf
    block: |
      br_netfilter
      overlay
      br_netfilter
      ip_vs
      ip_vs_rr
      ip_vs_wrr
      ip_vs_sh
      nf_conntrack
    create: true
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
    mode: "0644"

- name: Modify sysctl entries
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  with_items:
    - { key: net.bridge.bridge-nf-call-ip6tables, value: 1 }
    - { key: net.bridge.bridge-nf-call-iptables, value: 1 }
    - { key: net.ipv4.ip_forward, value: 1 }
